// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Investment Portfolio Models
model CryptoAsset {
  id                String   @id @default(cuid())
  name              String   // e.g., Bitcoin, Ethereum
  symbol            String   // e.g., BTC, ETH
  exchange          String   // e.g., Binance, OKX, Bybit
  apiKeyId          String?  // Reference to API key (encrypted)
  balance           Float    // Current balance
  averagePrice      Float    // Average purchase price in USDT
  currentPrice      Float?   // Current price in USDT
  usdtVndRate       Float    // Custom USDT/VND rate for accurate VND calculation
  alertThreshold    Float?   // Alert when price changes by this percentage
  stopLoss          Float?   // Stop loss price
  takeProfit        Float?   // Take profit price
  notes             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  transactions      CryptoTransaction[]
}

model CryptoTransaction {
  id          String      @id @default(cuid())
  assetId     String
  asset       CryptoAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)
  type        String      // BUY, SELL, TRANSFER
  amount      Float
  price       Float       // Price in USDT
  usdtVndRate Float       // USDT/VND rate at transaction time
  fee         Float       @default(0)
  date        DateTime
  notes       String?
  createdAt   DateTime    @default(now())
}

model GoldSilverAsset {
  id              String   @id @default(cuid())
  type            String   // SJC_GOLD_BAR, JEWELRY_GOLD, SILVER
  name            String   // e.g., "Vàng SJC 1 lượng", "Nhẫn vàng 24K"
  weight          Float    // Weight in grams or taels
  unit            String   // gram, chỉ, lượng
  purchasePrice   Float    // Purchase price per unit in VND
  currentPrice    Float?   // Current market price per unit
  vendor          String?  // SJC, DOJI, PNJ, etc.
  purchaseDate    DateTime
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model FundAsset {
  id              String   @id @default(cuid())
  name            String   // Fund name
  fundCode        String   // Fund code
  fundCompany     String   // Dragon Capital, VinaCapital, SSIAM, etc.
  type            String   // OPEN_ENDED, ETF
  units           Float    // Number of units owned
  avgNavPrice     Float    // Average NAV at purchase
  currentNav      Float?   // Current NAV
  purchaseDate    DateTime
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  transactions    FundTransaction[]
}

model FundTransaction {
  id        String     @id @default(cuid())
  assetId   String
  asset     FundAsset  @relation(fields: [assetId], references: [id], onDelete: Cascade)
  type      String     // BUY, SELL
  units     Float
  navPrice  Float
  amount    Float
  date      DateTime
  notes     String?
  createdAt DateTime   @default(now())
}

model CashAsset {
  id              String   @id @default(cuid())
  name            String   // e.g., "Tiền mặt VND", "Tiền mặt USD"
  currency        String   // VND, USD, EUR, etc.
  amount          Float    // Current amount in the currency
  location        String?  // Where it's stored: "Nhà", "Két sắt", etc.
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  transactions    CashTransaction[]
}

model CashTransaction {
  id          String     @id @default(cuid())
  assetId     String
  asset       CashAsset  @relation(fields: [assetId], references: [id], onDelete: Cascade)
  type        String     // DEPOSIT, WITHDRAW, EXCHANGE
  amount      Float
  description String
  date        DateTime
  notes       String?
  createdAt   DateTime   @default(now())
}

model RealEstateAsset {
  id              String   @id @default(cuid())
  type            String   // APARTMENT, HOUSE, LAND, COMMERCIAL
  name            String   // e.g., "Căn hộ Vinhomes Central Park"
  address         String   // Full address
  area            Float    // Area in square meters
  purchasePrice   Float    // Purchase price in VND
  currentPrice    Float?   // Current estimated value in VND
  purchaseDate    DateTime
  ownership       String?  // FULL, PARTIAL percentage
  rentalIncome    Float?   // Monthly rental income if applicable
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Credit Card Arbitrage Models
model CreditCard {
  id                  String   @id @default(cuid())
  bankName            String   // VIB, HSBC, Techcombank, etc.
  cardName            String   // Card product name
  lastFourDigits      String   // Last 4 digits for identification
  statementDay        Int      // Day of month for statement (1-31)
  interestFreeDays    Int      // Total interest-free period (45, 55 days)
  paymentDueDays      Int      // Days after statement for payment (typically 15-20)
  creditLimit         Float?   // Credit limit in VND
  notes               String?
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  transactions        CardTransaction[]
  reminders           PaymentReminder[]
}

model CardTransaction {
  id                  String       @id @default(cuid())
  cardId              String
  card                CreditCard   @relation(fields: [cardId], references: [id], onDelete: Cascade)
  amount              Float        // Transaction amount in VND
  description         String
  transactionDate     DateTime
  statementDate       DateTime?    // Calculated statement date
  dueDate             DateTime?    // Calculated due date
  isPaid              Boolean      @default(false)
  savingsRecommended  Boolean      @default(false) // Whether savings was recommended
  savingsAmount       Float?       // Amount put in savings
  savingsInterest     Float?       // Estimated interest from savings
  actualInterest      Float?       // Actual interest earned
  notes               String?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
}

model PaymentReminder {
  id              String      @id @default(cuid())
  cardId          String
  card            CreditCard  @relation(fields: [cardId], references: [id], onDelete: Cascade)
  transactionId   String?     // Optional reference to specific transaction
  reminderDate    DateTime
  dueDate         DateTime
  amount          Float
  message         String
  isCompleted     Boolean     @default(false)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

// Savings Recommendation Models
model SavingsRecommendation {
  id                  String   @id @default(cuid())
  cardTransactionId   String?  // Link to card transaction if applicable
  amount              Float    // Amount to save in VND
  recommendationType  String   // TERM_DEPOSIT_1M, FLEXIBLE_SAVINGS, MMF
  estimatedInterest   Float    // Estimated interest to earn
  interestRate        Float    // Annual interest rate
  startDate           DateTime
  endDate             DateTime
  bankName            String?  // Recommended bank
  productName         String?  // Savings product name
  isAccepted          Boolean  @default(false)
  notes               String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

// API Keys for Exchange Integration (Encrypted)
model ExchangeApiKey {
  id          String   @id @default(cuid())
  exchange    String   // BINANCE, OKX, BYBIT
  apiKey      String   // Encrypted API key
  secretKey   String   // Encrypted secret key
  isReadOnly  Boolean  @default(true) // Must be read-only for security
  isActive    Boolean  @default(true)
  lastSyncAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Price History for tracking
model PriceHistory {
  id        String   @id @default(cuid())
  assetType String   // CRYPTO, GOLD, FUND
  assetId   String   // ID of the asset
  symbol    String   // Asset symbol/code
  price     Float
  currency  String   // USDT, VND
  source    String   // API source
  timestamp DateTime
  createdAt DateTime @default(now())
}

// User settings
model Settings {
  id                      String   @id @default(cuid())
  defaultUsdtVndRate      Float    @default(24000) // Default USDT/VND rate
  enablePriceAlerts       Boolean  @default(true)
  enablePaymentReminders  Boolean  @default(true)
  reminderDaysBefore      Int      @default(2) // Days before due date to remind
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}

// Portfolio Rebalancing Models
model PortfolioAllocation {
  id              String   @id @default(cuid())
  assetClass      String   // CRYPTO, GOLD_SILVER, FUNDS, CASH, REAL_ESTATE
  targetPercent   Float    // Target allocation percentage (0-100)
  currentPercent  Float?   // Current allocation percentage
  isActive        Boolean  @default(true)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model RebalanceRecommendation {
  id              String   @id @default(cuid())
  assetClass      String   // CRYPTO, GOLD_SILVER, FUNDS, CASH, REAL_ESTATE
  currentValue    Float    // Current value in VND
  targetValue     Float    // Target value in VND
  difference      Float    // Difference in VND (positive = buy, negative = sell)
  action          String   // BUY, SELL, HOLD
  priority        String   // HIGH, MEDIUM, LOW
  isExecuted      Boolean  @default(false)
  executedAt      DateTime?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// Goal-Based Investing Models
model InvestmentGoal {
  id              String   @id @default(cuid())
  name            String   // e.g., "Retirement", "House Down Payment", "Children Education"
  type            String   // RETIREMENT, HOUSE, EDUCATION, TRAVEL, OTHER
  targetAmount    Float    // Target amount in VND
  currentAmount   Float    @default(0) // Current saved amount
  deadline        DateTime // Target date to achieve goal
  priority        String   // HIGH, MEDIUM, LOW
  monthlyContribution Float? // Recommended monthly contribution
  isCompleted     Boolean  @default(false)
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  allocations     GoalAllocation[]
}

model GoalAllocation {
  id              String          @id @default(cuid())
  goalId          String
  goal            InvestmentGoal  @relation(fields: [goalId], references: [id], onDelete: Cascade)
  assetClass      String          // CRYPTO, GOLD_SILVER, FUNDS, CASH, REAL_ESTATE
  allocationPercent Float         // Percentage allocated to this asset class
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
}

// Open Banking & Automation Models
model BankConnection {
  id              String   @id @default(cuid())
  bankName        String   // VCB, ACB, Techcombank, etc.
  accountNumber   String   // Last 4 digits for security
  accountType     String   // CHECKING, SAVINGS
  connectionType  String   // API, MANUAL
  isActive        Boolean  @default(true)
  lastSyncAt      DateTime?
  accessToken     String?  // Encrypted access token
  refreshToken    String?  // Encrypted refresh token
  expiresAt       DateTime?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  transactions    BankTransaction[]
}

model BankTransaction {
  id              String         @id @default(cuid())
  connectionId    String
  connection      BankConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  transactionDate DateTime
  description     String
  amount          Float          // Positive for credit, negative for debit
  balance         Float?         // Account balance after transaction
  category        String?        // AUTO, FOOD, TRANSPORT, SHOPPING, etc.
  isProcessed     Boolean        @default(false)
  notes           String?
  createdAt       DateTime       @default(now())
}

model QRCodeScan {
  id              String   @id @default(cuid())
  scanDate        DateTime @default(now())
  qrType          String   // VIETQR, INVOICE, OTHER
  merchantName    String?
  amount          Float?
  description     String?
  category        String?  // AUTO_CATEGORIZED
  isProcessed     Boolean  @default(false)
  rawData         String?  // JSON data from QR
  notes           String?
  createdAt       DateTime @default(now())
}

// Smart Reports & Analytics Models
model CashflowReport {
  id              String   @id @default(cuid())
  reportMonth     DateTime // Month of the report
  totalIncome     Float    // Total income for the month
  totalExpenses   Float    // Total expenses
  totalInvestment Float    // Investment contributions
  savingsRate     Float    // Percentage saved
  netCashflow     Float    // Income - Expenses - Investment
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model PerformanceMetric {
  id              String   @id @default(cuid())
  metricDate      DateTime // Date of calculation
  portfolioValue  Float    // Total portfolio value
  twrr            Float?   // Time-Weighted Rate of Return
  mwrr            Float?   // Money-Weighted Rate of Return  
  benchmarkReturn Float?   // Benchmark comparison (e.g., VN-Index)
  sharpeRatio     Float?   // Risk-adjusted return
  volatility      Float?   // Portfolio volatility
  notes           String?
  createdAt       DateTime @default(now())
}
